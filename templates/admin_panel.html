<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
/* ---------------------------------------------------
   GLOBAL VARIABLES (LIGHT + DARK MODE)
--------------------------------------------------- */
:root {
    --bg: #f5f7fb;
    --text: #222;
    --card-bg: #ffffff;
    --primary: #4a90e2;
    --danger: #ff4d4f;
    --shadow: rgba(0,0,0,0.07);
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg: #121212;
        --text: #e3e3e3;
        --card-bg: #1c1c1c;
        --primary: #77aaff;
        --shadow: rgba(0,0,0,0.4);
    }
}

/* RESET */
* { margin:0; padding:0; box-sizing:border-box; }

body {
    background: var(--bg);
    color: var(--text);
    font-family: "Poppins",sans-serif;
    display: flex;
    min-height: 100vh;
    animation: fadeIn .7s ease-in-out;
}

@keyframes fadeIn {
    from { opacity:0; transform:translateY(10px); }
    to   { opacity:1; transform:translateY(0); }
}

/* SIDEBAR */
.sidebar {
    width: 240px;
    background: var(--card-bg);
    color: var(--text);
    padding: 25px;
    position: fixed;
    left: 0; top: 0;
    bottom: 0;
    box-shadow: 2px 0 10px var(--shadow);
}

.sidebar h2 {
    margin-bottom: 30px;
    font-size: 22px;
    font-weight: 700;
}

.sidebar a {
    display: block;
    padding: 12px 0;
    font-size: 16px;
    color: var(--text);
    text-decoration: none;
    border-radius: 8px;
    transition: .3s;
}

.sidebar a:hover {
    background: var(--primary);
    color: white;
    padding-left: 10px;
}

/* MAIN CONTENT */
.main {
    flex: 1;
    margin-left: 260px;
    padding: 30px;
}

/* HEADER */
.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:25px;
}

.logout-btn {
    background: var(--primary);
    color:white;
    padding:10px 16px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 5px 12px var(--shadow);
    transition:.3s;
}

.logout-btn:hover {
    transform:translateY(-3px);
}

/* CARDS */
.cards {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:20px;
    margin-bottom:25px;
}

.card {
    background: var(--card-bg);
    padding:25px;
    border-radius:16px;
    box-shadow:0 8px 20px var(--shadow);
    animation: slideUp .6s ease;
}

@keyframes slideUp {
    from { opacity:0; transform:translateY(20px); }
    to { opacity:1; transform:translateY(0); }
}

.card:hover {
    transform: translateY(-5px);
    transition:.3s;
}

.card-title {
    color:#888;
    font-size:15px;
}
.card-value {
    font-size:34px;
    font-weight:700;
    margin-top:5px;
}

/* TABLE */
.table-wrapper {
    background: var(--card-bg);
    padding:15px;
    border-radius:16px;
    box-shadow:0 10px 25px var(--shadow);
    overflow-x:auto;
}

table {
    width:100%;
    min-width: 950px;
    border-collapse:collapse;
}

th {
    background: var(--primary);
    color:white;
    padding:14px;
    text-align:left;
    font-size:15px;
}

td {
    padding:14px;
    border-bottom:1px solid #ddd3;
}

tr:hover td {
    background:#e8f0ff20;
}

/* ACTIVITY BOX */
.activity-box {
    background:#f4f7ff10;
    padding:10px;
    border-radius:12px;
    max-height:180px;
    overflow-y:auto;
    border:1px solid #ddd3;
}

.created { color:#2ecc71; font-weight:600; }
.deleted { color:#e74c3c; font-weight:600; }

/* BUTTONS */
.delete-btn {
    background:var(--danger);
    color:white;
    padding:8px 13px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
    font-weight:600;
    box-shadow:0 4px 12px rgba(255,0,0,0.2);
    transition:.2s;
}

.delete-btn:hover {
    transform:scale(1.06);
    background:#d93434;
}

.protected {
    color:gray;
    font-style:italic;
}

/* MODALS (PURE CSS) */
.modal {
    position:fixed;
    left:0; top:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    display:none;
}

.modal:target {
    display:block;
}

.modal-box {
    background: var(--card-bg);
    width:90%;
    max-width:400px;
    margin:10% auto;
    padding:25px;
    border-radius:16px;
    animation:fadeIn .5s;
}

.modal input {
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #9993;
    background:var(--bg);
    color:var(--text);
}

.modal button {
    background:var(--primary);
    color:white;
    padding:10px 14px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:100%;
    margin-top:10px;
}

.close {
    display:block;
    text-align:center;
    margin-top:10px;
    color:var(--danger);
    font-size:18px;
    text-decoration:none;
}

/* CHART */
.chart {
    display:flex;
    gap:15px;
    height:140px;
    align-items:flex-end;
    margin-bottom:25px;
}

.bar {
    width:40px;
    background:var(--primary);
    border-radius:8px;
    height:0;
    animation:grow 1.4s forwards ease-out;
}

@keyframes grow {
    to { height:var(--value); }
}

</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="{{url_for('admin_panel')}}">Dashboard</a>
    <a href="#add-admin">Add Admin</a>
    <a href="{{url_for('logout')}}">Logout</a>
</div>

<!-- MAIN CONTENT -->
<div class="main">

    <div class="header">
        <h1>Dashboard</h1>
        <!-- <a href="{{url_for('logout')}}">
            <button class="logout-btn">Logout</button>
        </a> -->
    </div>

    <!-- CARDS -->
    <div class="cards">
        <div class="card">
            <div class="card-title">Total Users</div>
            <div class="card-value">{{ users|length }}</div>
        </div>

        <div class="card">
            <div class="card-title">Total Tasks</div>
            <div class="card-value">
                {{ users | map(attribute='tasks') | map('length') | sum }}
            </div>
        </div>
    </div>

    <!-- CHART -->
    <div class="chart">
        <div class="bar" style="--value:70%"></div>
        <div class="bar" style="--value:45%"></div>
        <div class="bar" style="--value:90%"></div>
    </div>

    <!-- USERS TABLE -->
    <div class="table-wrapper">
        <table>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Total Tasks</th>
                <th>Recent Activity</th>
                <th>Actions</th>
            </tr>

            {% for u in users %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.role }}</td>
                <td>{{ u.tasks|length }}</td>

                <td>
                    <div class="activity-box">
                        {% if u.task_logs %}
                            {% for log in u.task_logs %}
                                <div class="log-entry">
                                    {% if log.action == "created" %}
                                        <span class="created">Created</span>
                                    {% else %}
                                        <span class="deleted">Deleted</span>
                                    {% endif %}
                                    - "{{ log.task_title }}"
                                    <br><small>{{ log.timestamp }}</small>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p style="color:#888;">No activity.</p>
                        {% endif %}
                    </div>
                </td>

                <td>
                    {% if u.role != "admin" %}
                        <!-- Delete normal user -->
                        <form method="POST" action="{{ url_for('delete_admin', user_id=u.id) }}"
                              onsubmit="return confirm('Delete this user?');">
                            <button class="delete-btn">Delete</button>
                        </form>
                    {% else %}
                        {% if u.id != current_user.id %}
                            <!-- Delete other admin -->
                            <form method="POST" action="{{ url_for('delete_admin', user_id=u.id) }}"
                                  onsubmit="return confirm('Delete this admin?');">
                                <button class="delete-btn">Delete Admin</button>
                            </form>
                        {% else %}
                            <p class="protected">You</p>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<!-- ADD ADMIN MODAL -->
<div id="add-admin" class="modal">
    <div class="modal-box">
        <h3>Add Admin</h3>

        <form method="POST" action="{{url_for('add_admin')}}">
            <input name="username" placeholder="Username" required>
            <input name="email" placeholder="Email" required>
            <input name="password" placeholder="Password" type="password" required>
            <button type="submit">Create</button>
        </form>

        <a href="#" class="close">Close</a>
    </div>
</div>

</body>
</html>
